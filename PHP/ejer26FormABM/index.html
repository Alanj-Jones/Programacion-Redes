<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FORM ABM</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="doc">
        <div class="top">
            <div class="header">
                <header>Turnos</header>
            </div>
                
            <div class="topInput">
                <label for="">Orden:</label>
                <input type="text" id="orden" name="orden" placeholder="IdTurno" readonly value="IdTurno">
            </div>
            <div class="buttons">
                <button id="altaRegistro" onclick="abrirModalAlta()">Alta registro</button>
                <button id="delete">Borrar</button>
                <button id="load" onclick="cargaTabla();">Cargar datos</button>
            </div>        
                
        </div>
        <div class="tableContainer">

            <table>
                <thead>
                    <tr>
                        <th id="thTurnoId" campo-dato="turnos_IdTurno">Id del turno</th>
                        <th id="thTurnoApDr" campo-dato="turnos_ApellidoDr">Apellido Dr.</th>
                        <th id="thTurnoMat" campo-dato="turnos_Matricula">N° Matricula</th>                    
                        <th id="thTurnoEspec" campo-dato="turnos_Especialidad">Especialidad</th>
                        <th id="thTurnoApPa" campo-dato="turnos_ApellidoPaciente">Apellido del paciente</th>
                        <th id="thTurnoFeTu" campo-dato="turnos_FechaTurno">Fecha hora del turno</th>
                        <th id="thPdf" campo-dato="pdf">PDF</th>
                        <th id="thModis" campo-dato="modis">Modis</th>
                        <th id="thBajas" campo-dato="bajas">Bajas</th>
                    </tr>

                    <tr id="inputsFiltro">
                        <th campo-dato="turnos_IdTurno">
                            <input id="filtroIdTurno"  type="text">
                        </th>
                        <th campo-dato="turnos_ApellidoDr">
                            <input id="filtroApellidoDr"  type="text">
                        </th>
                        <th campo-dato="turnos_Matricula">
                            <input id="filtroMatricula"  type="text">
                        </th>                    
                        <th campo-dato="turnos_Especialidad">
                            <input id="filtroEspecialidad"  type="text">
                        </th>
                        <th campo-dato="turnos_ApellidoPaciente">
                            <input id="filtroApellidoPaciente"  type="text">
                        </th>
                        <th campo-dato="turnos_FechaTurno">
                            <input id="filtroFechaTurno"  type="text">
                        </th>
                        <th campo-dato="pdf"></th>
                        <th campo-dato="modis"></th>
                        <th campo-dato="bajas"></th>
                        
                    </tr>
                </thead>
                
                <tbody id="tbDatos"></tbody>
                
                <tfoot></tfoot>
                
            </table>
        </div>
        <h2 id="cantRegistros"></h2>
        <footer>Pie</footer>
    </div>
        <!-- FORMULARIO DE ALTA -->
        <div class="formularioAlta" id="formAlta" onchange="todoListoParaAlta()">
            <div class="topElements">
                <header>Encabezado Modal Formulario Alta</header>
                <button onclick="cerrarModalAlta()">X</button>
            </div>
            <div class="col1">
                <label for="altaID">IdTurno</label>
                <br>
                <input type="number" name="altaID" required id="altaID" min="0">
                <br> 
                <label for="altaApellidoDr">Apellido Dr.</label>
                <br>
                <input type="text" name="altaApellidoDr" requiered id="altaApellidoDr">
                <br>
                <label for="altaMatriculaDr">N°Matricula</label>
                <br>
                <input type="number" name="altaMatriculaDr" required id="altaMatriculaDr" min="0">
            </div>

            <div class="col2">
                <label for="altaEspecialidad">Especialidad</label>
                <br>
                <input type="text" name="altaEspecialidad" required id="altaEspecialidad">
                <br>
                <label for="altaApellidoPaciente">Apellido del paciente</label>
                <br>
                <input type="text" name="altaApellidoPaciente" required id="altaApellidoPaciente">
                <br>
                <label for="altaFechaTurno">Fecha/Hora del turno</label>
                <br>
                <input type="datetime-local" required name="altaFechaTurno" id="altaFechaTurno">
                <br>
                <form method="post" enctype="multipart/form-data">
                    <label for="documentoPdf">PDF:</label>
                    <br>
                    <input type="file" name="documentoPdf" id="formArticulosEntDocumentoPdfModi">
                </form>
            </div>
            <button id="altaValidar" class="validButton" disabled  onclick="Alta()">Enviar Alta</button>
        </div>

        <div class="" id=""></div>
        <!-- FORMULARIO DE MODIFICACION -->
        <div class="formularioAlta" id="formModi">
            <div class="topElements">
                <header>Encabezado Modal Formulario de Modificacion</header>
                <button onclick="cerrarModalModi()">X</button>
            </div>
            <div class="col1">
                <label for="modiID">IdTurno</label>
                <br>
                <input type="number" name="modiID" required id="modiID">
                <br> 
                <label for="modiApellidoDr">Apellido Dr.</label>
                <br>
                <input type="text" name="modiApellidoDr" requiered id="modiApellidoDr">
                <br>
                <label for="modiMatriculaDr">N°Matricula</label>
                <br>
                <input type="number" name="modiMatriculaDr" required id="modiMatriculaDr">
            </div>

            <div class="col2">
                <label for="modiEspecialidad">Especialidad</label>
                <br>
                <input type="text" name="modiEspecialidad" id="modiEspecialidad" >
                <br>
                <label for="modiApellidoPaciente">Apellido del paciente</label>
                <br>
                <input type="text" name="modiApellidoPaciente" id="modiApellidoPaciente">
                <br>
                <label for="modiFechaTurno">Fecha/Hora del turno</label>
                <br>
                <input type="datetime" name="modiFechaTurno" id="modiFechaTurno">
                <br>
                <label for="modiPDF">PDF:</label>
                <br>
                <input type="file" name="modiPDF" id="">        
            </div>
            <button id="modiValidar" class="validButton" onclick="ejecutarUpdate()">Enviar Modi</button>
        </div>

        <div class="" id=""></div>

    



<script src="../jquery.js"></script>
<script>

    function borrar(argIdTurno){
        if(confirm("Esta seguro?")){
            var objAjax = $.ajax({
                type:"get",
                url:"./delete.php",
                data:{
                    IdTurno : argIdTurno
                },
                success: function(){
                    cargaTabla();
                    cargaTabla();
                }
            })
        }else{
            alert("Ha sido cancelado.");
        }
    }

    function ejecutarBorrar(){
        var i = this.document.activeElement.getAttribute("class");
        borrar(i);
    }

    function todoListoParaAlta(){
            if (($("#altaID").isValid()==true) &&
                ($("#altaApellidoDr").isValid()==true) &&
                ($("#altaMatriculaDr").isValid()==true) &&
                ($("#altaEspecialidad").isValid()==true) &&
                ($("#altaApellidoPaciente").isValid()==true) &&
                ($("#altaFechaTurno").isValid()==true) ){

                    $("#altaValidar").attr("disabled",false);
                }else{
                    $("#altaValidar").attr("disabled",true);
                }
        };


    function Alta(){
        if(confirm("Esta Seguro?")){
            $objAjax = $.ajax({
                type:"post",
                url:"./alta.php",
                data:{
                IdTurno  : $("#altaID").val(),
                Matricula  : $("#altaMatriculaDr").val(),
                ApellidoDr  : $("#altaApellidoDr").val(),
                Especialidad  : $("#altaEspecialidad").val(),
                ApellidoPaciente  : $("#altaApellidoPaciente").val(),
                FechaTurno  : $("#altaFechaTurno").val(),
                documentoPdf : $("#formArticulosEntDocumentoPdfModi").val()

                },
                success: function(){
                    cargaTabla();
                    cargaTabla();
                    cerrarModalAlta()
                    
                }
            })
        }else{
            alert("Se ha cancelado la operacion");
        }
    };

    function update(argIdTurno){
        if (confirm("Estas seguro?")){
            $objAjax = $.ajax({
                type:"POST",
                url:"./modi2.php",
                data:{
                    IdTurno: argIdTurno,
                    ApellidoDr :$("#modiApellidoDr").val(),
                    Matricula :$("#modiMatriculaDr").val(),
                    Especialidad:$("#modiEspecialidad").val(),
                    ApellidoPaciente:$("#modiApellidoPaciente").val(),
                    FechaTurno:$("#modiFechaTurno").val()
                },
                success: function(){
                    cargaTabla();
                    cargaTabla();
                    cerrarModalModi();
                }
            })
        }else{
            alert("Ha cancelado la operacion");
        }
    };

    function ejecutarUpdate(){
        console.log(savedValue);
        update(savedValue);
    };


    //Cuando se carga el documento se ejecuta esto para impedir que se vean las ventanas modales de primeras sin haberlas llamado
    $(document).ready(function(){
        $("#formAlta").css("visibility","hidden");
        $("#formModi").css("visibility","hidden");
    });

    //Funcion para abrir la ventana modal con el boton 'Alta Registro'
    function abrirModalAlta(){
        $("#formAlta").css("visibility","visible");
        $("#doc").addClass("contenedorDesactivado");
    };

    //Funcion para cerrar la ventana modal de Alta con el boton 'X'
    function cerrarModalAlta(){
        $("#formAlta").css("visibility","hidden");
        $("#doc").removeClass("contenedorDesactivado");
    };

    //Funcion para cerrar la ventana modal de Alta con el boton 'X'
    function cerrarModalModi(){
        $("#formModi").css("visibility","hidden");
        $("#doc").removeClass("contenedorDesactivado");
    };

    
    var savedValue;
    //Funcion para abrir la ventana modal de modificacion
    function abrirModalModi(){
        $("#formModi").css("visibility","visible");
        //IMPORTANTISIMO
        var i = this.document.activeElement.getAttribute("class");
        savedValue = i;
        completarFichaModi(i);
        $("#doc").addClass("contenedorDesactivado");
    };

    function completarFichaModi(argIdTurno){
        $("#formModi").val(argIdTurno);
        var objAjax = $.ajax({
            type:"get",
            url:"./modi.php",
            data:{IdTurno:argIdTurno},
            success:function(respuestaDelServer,estado){
                console.log(respuestaDelServer);
                objetoDato = JSON.parse(respuestaDelServer);
                
                $("#modiID").val(objetoDato.IdTurno);
                $("#modiApellidoDr").val(objetoDato.ApellidoDr);
                $("#modiMatriculaDr").val(objetoDato.Matricula);
                $("#modiEspecialidad").val(objetoDato.Especialidad);
                $("#modiApellidoPaciente").val(objetoDato.ApellidoPaciente);
                $("#modiFechaTurno").val(objetoDato.FechaTurno);
            }
        });
    };
   

    //Esta funcion Se va a encargar de realizar la consulta ajax y traer los datos del servidor.
    function cargaTabla(){
                //Vacio la tabla por si la cargo dos veces no se me dupliquen los registros
                $("#tbDatos").empty();
                //añado un elemento temporal para mostrar que se esta esperando la respuesta del servidor
                $("#tbDatos").html("<p>Esperando respuesta....></p>")
                //Comienzo de 
                var objAjax = $.ajax({
                    //type: puede ser get o post. En el caso de get se van a buscar datos mientras que con post se van a 'postear'
                    type:"get",
                    //Indicamos la direccion del archivo php al cual se quiere acceder
                    url:"datosConexion.php",
                    //Aca especificamos los datos que se le van a pasar a la consulta de php
                    data:{
                        orden: $("#orden").val(),
                        //En esta parte voy a acceder a los valores de los filtros (los inputs) para pasarselos como parametro a la consulta php en el caso
                        //que se quiera ordenar de alguna manera en particular
                        filtroIdTurno : $("#filtroIdTurno").val(),
                        filtroApellidoDr : $("#filtroApellidoDr").val(),
                        filtroMatricula : $("#filtroMatricula").val(),
                        filtroEspecialidad : $("#filtroEspecialidad").val(),
                        filtroApellidoPaciente : $("#filtroApellidoPaciente").val(),
                        filtroFechaTurno : $("#filtroFechaTurno").val()
                    },
                    //Indicaremos que hacer en el caso que la consulta sea aceptada
                    success: function(respuestaDelServer,estado){
                        //Borramos el tbody para quitar el texto de 'esperando la respuesta'
                        $("#tbDatos").empty();
                        //console.log(respuestaDelServer);\\
                        //Convertiremos la respuesta que nos dio el servidor a un archivo de formato JSON para poder trabajar con mayor facilidad
                        objJson = JSON.parse(respuestaDelServer);

                        //El archivo json que se nos devuelve tendra como nombre 'turnos'
                        var objTbDatos = $("#tbDatos");
                        //Usamos este metodo foreach para que por cada turno nos extraiga los datos de cada uno de sus campos para posteriormente poder 
                        //pasarselos a nuestro tbody en formato de filas
                        objJson.turnos.forEach(function(argValor,argIndice){
                            var i = 1;

                            //Aqui creo el table row donde ira cada nueva fila
                            var objTr = document.createElement("tr");
                            objTr.setAttribute("class","DB");
                            
                            //De aca en adelante se crea un objeto td que sera insertado en la fila anteriormente creada
                            var objTdId = document.createElement("td");
                            objTdId.setAttribute("campo-dato","turnos_IdTurno");
                            objTdId.innerHTML= argValor.IdTurno;

                            var objTdApellidoDr = document.createElement("td");
                            objTdApellidoDr.setAttribute("campo-dato","turnos_ApellidoDr");
                            objTdApellidoDr.innerHTML= argValor.ApellidoDr;

                            var objTdMatricula = document.createElement("td");
                            objTdMatricula.setAttribute("campo-dato","turnos_Matricula");
                            objTdMatricula.innerHTML= argValor.Matricula;

                            var objTdEspecialidad = document.createElement("td");
                            objTdEspecialidad.setAttribute("campo-dato","turnos_Especialidad");
                            objTdEspecialidad.innerHTML= argValor.Especialidad;

                            var objTdApellidoPaciente = document.createElement("td");
                            objTdApellidoPaciente.setAttribute("campo-dato","turnos_ApellidoPaciente");
                            objTdApellidoPaciente.innerHTML= argValor.ApellidoPaciente;

                            var objTdFechaTurno = document.createElement("td");
                            objTdFechaTurno.setAttribute("campo-dato","turnos_FechaTurno");
                            objTdFechaTurno.innerHTML= argValor.FechaTurno;

                            var objTdPDF = document.createElement("td");
                            objTdPDF.setAttribute("campo-dato","pdf");
                            objTdPDF.innerHTML = "<button>Doc.pdf</button>";
                           
                            var objTdMod = document.createElement("td");
                            objTdMod.setAttribute("campo-dato","modis");
                            objTdMod.innerHTML = "<button id='modi' class="+"'"+argValor.IdTurno+"'"+"onclick='abrirModalModi()'>MODI</button>";

                            var objTdBaja = document.createElement("td");
                            objTdBaja.setAttribute("campo-dato","bajas");
                            objTdBaja.innerHTML = "<button id='baja' class="+"'"+argValor.IdTurno+"'"+"onclick='ejecutarBorrar()'>BORRAR</button>";



                            //añado los td's creados al tr
                            objTr.append(objTdId,objTdApellidoDr,objTdMatricula,objTdEspecialidad,objTdApellidoPaciente,objTdFechaTurno,objTdPDF, objTdMod, objTdBaja);
                            //añado cada tr a un objeto
                            objTbDatos.append(objTr);                        
                        });
                    //añado el objeto con todos los tr's a mi objeto tbody que tiene el id 'tbdatos'
                    $("#tbDatos").append(objTbDatos);
                    $("#cantRegistros").html("Nro de registros: " + objJson.turnos.length);
                    }

                });
            };

            //Funcion para borrar el table Body
            $("#delete").click(function(){
                $("#tbDatos").empty();
            });


            //Funcion para cargar la tabla de acuerdo al Id del turno
            $(document).ready(function(){
                $("#thTurnoId").click(function(){
                    $("#orden").val("IdTurno");
                    cargaTabla();
                });
            });
            //Funcion para cargar la tabla de acuerdo a la matricula del doctor
            $(document).ready(function(){
                $("#thTurnoMat").click(function(){
                    $("#orden").val("Matricula");
                    cargaTabla();
                });
            });
            //Funcion para cargar la tabla de acuerdo al apellido del doctor
            $(document).ready(function(){
                $("#thTurnoApDr").click(function(){
                    $("#orden").val("ApellidoDr");
                    cargaTabla();
                });
            });

            //Funcion para cargar la tabla de acuerdo a la especialidad
            $(document).ready(function(){
                $("#thTurnoEspec").click(function(){
                    $("#orden").val("Especialidad");
                    cargaTabla();
                });
            });

            //Funcion para cargar la tabla de acuerdo al  Apellido del paciente
            $(document).ready(function(){
                $("#thTurnoApPa").click(function(){
                    $("#orden").val("ApellidoPaciente");
                    cargaTabla();
                });
            });

            //Funcion para cargar la tabla de acuerdo a la fecha del turno
            $(document).ready(function(){
                $("#thTurnoFeTu").click(function(){
                    $("#orden").val("FechaTurno");
                    cargaTabla();
                });
            });

    
    $.fn.isValid = function(){
         return this[0].checkValidity()
    }





</script>
<script src="./script.js"></script>
    
</body>
</html>